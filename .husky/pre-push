#!/bin/bash
# .git/hooks/pre-push
# based of this reddit link with modifications by Gemini Pro 2.5
# https://www.reddit.com/r/git/comments/3o1tut/precommit_hook_to_make_sure_you_updated_the/
#
# A git pre-push hook to verify that the package.json version has been updated
# when pushing to remote.
#

# --- Script Configuration ---
# Exit immediately if a command exits with a non-zero status.
set -o errexit
# Treat unset variables as an error.
set -o nounset

# The path to your package.json file, relative to the repository root.
PACKAGE_JSON_FILE="package.json"
# The stable base branch to compare against.
BASE_BRANCH="origin/main"

echo "--- [Git Hook] Running pre-push version check ---"
echo "Comparing against base branch: '$BASE_BRANCH'"

# The pre-push hook receives a list of refs to be pushed on its standard input
# in the format: <local ref> <local sha> <remote ref> <remote sha>
# This loop reads that input line by line.
while read local_ref local_sha remote_ref remote_sha
do
    # --- 1. Filter for Relevant Push Events ---

    # We only care about updating branches, which look like "refs/heads/branch-name".
    # This check skips pushes of tags or other ref types.
    if [[ ! "$local_ref" =~ ^refs/heads/ ]]; then
        echo "Push does not involve a branch ($local_ref), skipping version check."
        continue
    fi

    # Define the 'null sha' which indicates a new or deleted branch.
    NULL_SHA="0000000000000000000000000000000000000000"

    # If the remote_sha is null, a new branch is being created.
    # We don't need to check for a version bump in this case.
    if [ "$remote_sha" = "$NULL_SHA" ]; then
        echo "A new branch ($local_ref) is being pushed, skipping version check."
        continue
    fi

    # If the local_sha is null, the branch is being deleted. Skip the check.
    if [ "$local_sha" = "$NULL_SHA" ]; then
        echo "Branch ($local_ref) is being deleted, skipping version check."
        continue
    fi

    # --- 2. Check for Code Changes ---

    # Construct the commit range to see what is being pushed.
    # This range includes all commits that are in the local branch but not yet in the remote branch.
    commit_range="$remote_sha..$local_sha"
    branch_name=${local_ref#refs/heads/}
    base_branch_name=${BASE_BRANCH#origin/}

    # Don't run the check if we are pushing the base branch itself.
    if [ "$branch_name" = "$base_branch_name" ]; then
        echo "Pushing to the base branch ('$branch_name'), skipping version check."
        continue
    fi

    echo "Checking branch '$branch_name' for commits in range $commit_range"

    # Ensure we have the latest version of the base branch for an accurate comparison.
    echo "Fetching latest changes for '$BASE_BRANCH'..."
    git fetch origin "$base_branch_name" >/dev/null 2>&1

    # Helper function to extract the version string from package.json at a specific git ref.
    get_version_from_ref() {
        local ref=$1
        local file_path=$2
        # Use 'git show' to get the file content at a specific ref.
        # Pipe to grep to find the version line, then sed to extract the version number.
        # '|| true' prevents the script from exiting if grep finds nothing.
        git show "${ref}:${file_path}" 2>/dev/null | \
            grep '"version":' | \
            sed -E 's/.*"version": *"([^"]+)".*/\1/' || true
    }

    # Get the version from the commit being pushed.
    local_version=$(get_version_from_ref "$local_sha" "$PACKAGE_JSON_FILE")
    # Get the version from the base branch.
    main_version=$(get_version_from_ref "$BASE_BRANCH" "$PACKAGE_JSON_FILE")

    echo "Version in '$branch_name' is: '$local_version'"
    echo "Version in '$BASE_BRANCH' is: '$main_version'"

    # If we couldn't read a version from either branch, we can't compare.
    # This might happen if package.json doesn't exist on the base branch yet.
    if [ -z "$local_version" ] || [ -z "$main_version" ]; then
        echo "Warning: Could not determine version from one of the branches. Skipping check."
        continue
    fi

    # --- 3. Enforce Version Bump ---

    # If the version in the feature branch is the same as the base branch...
    if [ "$local_version" = "$main_version" ]; then
        # ...we should only fail the push if there are actual new commits being pushed.
        commit_count=$(git rev-list --count "$commit_range")

        if [ "$commit_count" -gt 0 ]; then
            echo "============================================================" >&2
            echo "!! PUSH REJECTED !!" >&2
            echo "The version in '$PACKAGE_JSON_FILE' ('$local_version') has not been updated" >&2
            echo "relative to the base branch '$BASE_BRANCH' ('$main_version')." >&2
            echo "Please increment the version before pushing." >&2
            echo "============================================================" >&2
            exit 1 # Abort the push with a failure code
        fi
    else
        echo "Version has been updated from '$main_version' to '$local_version'. Great!"
    fi
done

echo "--- [Git Hook] All checks passed. Proceeding with push. ---"
exit 0 # Success, allow the push
