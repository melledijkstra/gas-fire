<p>
  Paste here your configuration for the automatic categorization. The
  configuration is a JSON object where the key is a category and the value an
  array of regular expressions. These regular expressions will be used like `new
  RegExp("yourregex")`
</p>
<div>
  <label for="settings_automatic_categorization">
    Automatic Categorization Config
  </label>
  <textarea
    disabled
    onchange="validateConfig()"
    id="settings_automatic_categorization"
  >
    Loading...
  </textarea>
</div>
<p id="validation-status"></p>
<button id="save-btn" disabled onclick="saveAutomaticCategorizationConfig()">
  Store configuration
</button>
<style>
  #settings_automatic_categorization {
    max-height: 400px;
    border: 1px solid black;
  }
</style>
<script>
  // this function should retrieve the config in JSON format
  const setAutomaticCategorizationConfig = (config) => {
    const elem = document.getElementById('settings_automatic_categorization');
    elem.value = JSON.stringify(config, null, 2);
    elem.disabled = false;
    M.textareaAutoResize(elem);
  };

  const validateConfig = () => {
    const inputElem = document.getElementById(
      'settings_automatic_categorization'
    );
    const statusElem = document.getElementById('validation-status');
    const button = document.getElementById('save-btn');
    try {
      if (JSON.parse(inputElem.value)) {
        statusElem.innerText = '✅';
        button.disabled = false;
        return;
      }
    } catch (ignore) {}

    statusElem.innerText = '❌';
    button.disabled = true;
  };

  const saveAutomaticCategorizationConfig = () => {
    const elem = document.getElementById('settings_automatic_categorization');
    try {
      const config = JSON.parse(elem.value);
      google.script.run
        .withSuccessHandler(() => alert('Configuration Saved!'))
        .withFailureHandler(() =>
          alert('Failed to store the config! Try again, is your JSON valid?')
        )
        .storeAutomaticCategorizationConfig(config);
    } catch (ignore) {
      alert('Failed to store the config! Try again, is your JSON valid?');
    }
  };

  const loadAutomaticCategorizationConfig = () => {
    console.log('loading config');
    google.script.run
      .withSuccessHandler(setAutomaticCategorizationConfig)
      .withFailureHandler(() => {
        alert('Failed to retrieve configuration');
        document.getElementById(
          'settings_automatic_categorization'
        ).disabled = false;
      })
      .getAutomaticCategorizationConfig();
  };

  window.addEventListener('load', loadAutomaticCategorizationConfig);
</script>
