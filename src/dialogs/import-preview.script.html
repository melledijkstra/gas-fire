<script>
  const generatePreview = (data, strategy) => {
    google.script.run
      .withSuccessHandler(onGeneratePreviewSuccess)
      .withFailureHandler(onFailure)
      .generatePreview(data, strategy);
  };

  const onGeneratePreviewSuccess = ({ result, newBalance }) => {
    console.log('received from server', { result, newBalance });
    setStatusText(`Your new balance: ${newBalance}`);

    setPreview(result);
  };

  const csvToJson = (csvData) => {
    const headers = csvData.shift();
    return csvData.map((row) => {
      let jsonRow = {};
      row.forEach((value, index) => {
        jsonRow[headers[index]] = value;
      });
      return jsonRow;
    });
  };

  const setTableData = (data) => {
    try {
      tabulator.setData(data);
    } catch (error) {
      alert(`Could not set table data (error: ${error})`);
    }
  };

  const setPreview = (data) => {
    setTableData(csvToJson(data));
  };
</script>
